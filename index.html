<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœ¼åŠ¨è¿½è¸ªæ•°æ®æ”¶é›†ç³»ç»Ÿ - è§†é¢‘è§‚çœ‹ç‰ˆ</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB6O5l6uZa-6sywCZTGRJx2CKPuq3KeBF0",
            authDomain: "index-9f58d.firebaseapp.com",
            projectId: "index-9f58d",
            storageBucket: "index-9f58d.appspot.com",
            messagingSenderId: "718279245978",
            appId: "1:718279245978:web:93a9a07473ad8d3e6a5f23"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ç”Ÿæˆå”¯ä¸€ç”¨æˆ·ID
        const generateUniqueUserId = () => {
            const timestamp = Date.now();
            const randomStr = Math.random().toString(36).substr(2, 9);
            return `user_${timestamp}_${randomStr}`;
        };

        const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const userId = generateUniqueUserId(); // æ¯ä¸ªç”¨æˆ·éƒ½æœ‰å”¯ä¸€ID
        console.log('ä¼šè¯ID:', sessionId);
        console.log('ç”¨æˆ·ID:', userId);

        // åŠ¨æ€åŠ è½½WebGazer
        async function loadWebGazerScript() {
            const sources = [
                'https://webgazer.cs.brown.edu/webgazer.js',
                'https://unpkg.com/webgazer@2.0.2/dist/webgazer.js',
                'https://cdn.jsdelivr.net/npm/webgazer@2.0.2/dist/webgazer.min.js'
            ];
            for (const source of sources) {
                try {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = source;
                        script.onload = resolve;
                        script.onerror = () => reject(new Error(`æ— æ³•ä» ${source} åŠ è½½WebGazer`));
                        script.timeout = 10000;
                        document.head.appendChild(script);
                    });
                    console.log(`WebGazerä» ${source} åŠ è½½æˆåŠŸ`);
                    return true;
                } catch (error) {
                    console.error(`åŠ è½½å¤±è´¥: ${error.message}`);
                }
            }
            return false;
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.0/heatmap.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- æ–°å¢ï¼šå¼•å…¥ SheetJS åº“ç”¨äºç”Ÿæˆ Excel æ–‡ä»¶ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; background: #f0f0f0; }
        #heatmapContainer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; visibility: hidden; }
        #plotting_canvas { position: fixed; top: 0; left: 0; cursor: crosshair; z-index: 900; pointer-events: none; }
        #content { position: relative; z-index: 1; padding: 30px; max-width: 800px; margin: 10px auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #statsPanel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            z-index: 2000;
            width: 200px;
            font-size: 11px;
        }
        .stat-item {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stat-value {
            font-weight: bold;
            color: #4CAF50;
            font-size: 10px;
        }
        #debugPanel { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.9); color: #00ff00; padding: 15px; border-radius: 8px; z-index: 2000; max-width: 350px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; display: none; }
        .controls { text-align: center; margin: 20px 0; }
        .btn { background: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 0 10px; font-size: 16px; transition: background 0.3s; }
        .btn:hover { background: #45a049; }
        .btn.danger { background: #f44336; }
        .btn.danger:hover { background: #da190b; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn.test { background: #2196F3; }
        .btn.test:hover { background: #1976D2; }
        .btn.toggle { background: #FF9800; }
        .btn.toggle:hover { background: #F57C00; }
        .status { position: fixed; top: 20px; left: 20px; padding: 10px 15px; border-radius: 20px; font-weight: bold; z-index: 2000; }
        .status.ready { background: #4CAF50; color: white; }
        .status.calibrating { background: #ff9800; color: white; }
        .status.error { background: #f44336; color: white; }
        .status.initializing { background: #2196F3; color: white; }
        .status.loading { background: #9C27B0; color: white; }

        #webgazerVideoContainer {
            display: block !important;
            position: fixed !important;
            top: 0px !important;
            left: 0px !important;
            width: 320px !important;
            height: 240px !important;
            z-index: 1;
        }

        .Calibration {
            width: 20px;
            height: 20px;
            border-radius: 25px;
            background-color: red;
            opacity: 0.2;
            border: 1px solid black;
            position:fixed;
            z-index: 100000;
        }
        #Pt1{ top: 70px; left:340px; }
        #Pt2{ top: 70px; left:50vw; margin-left: 340; }
        #Pt3{ top: 70px; right:2vw; }
        #Pt4{ top:50vh; left:2vw; }
        #Pt5{ top: 50vh; left: 50vw; }
        #Pt6{ top: 50vh; right:2vw; }
        #Pt7{ bottom:2vw; left: 2vw; }
        #Pt8{ bottom:2vw; left:50vw; }
        #Pt9{ bottom:2vw; right:2vw; }

        #Accuracy { background-color: #222; color: white; padding: 8px; border-radius: 5px; text-align: center; font-size: 11px; margin: 8px 0; }
        .collection-status { margin-top: 10px; padding: 8px; border-radius: 5px; text-align: center; font-size: 10px; }
        .collection-status.connected { background: #4CAF50; color: white; }
        .collection-status.disconnected { background: #f44336; color: white; }
        .collection-status.uploading { background: #ff9800; color: white; }
        .firebase-status { margin-top: 8px; padding: 8px; border-radius: 4px; text-align: center; font-size: 10px; }
        .heatmap-visible { visibility: visible !important; }

        #videoInfoOverlay {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            z-index: 10000;
            pointer-events: none;
            visibility: hidden;
            border: 2px solid white;
        }

        .video-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        /* å¼¹çª—è¾“å…¥æ¡†æ ·å¼ */
        .swal-content__input {
            display: block;
            width: 90%;
            margin: 10px auto;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div id="status" class="status loading">æ­£åœ¨åŠ è½½åº“æ–‡ä»¶...</div>
    <canvas id="plotting_canvas" width="500" height="500"></canvas>

    <div id="statsPanel">
        <h4 style="margin: 0 0 8px 0; text-align: center; color: #4CAF50; font-size: 13px;">ğŸ“Š çœ¼åŠ¨æ•°æ®ç»Ÿè®¡</h4>
        <div class="stat-item"><span>å­¦å·:</span><span id="studentIdDisplay" class="stat-value">N/A</span></div>
        <div class="stat-item"><span>å§“å:</span><span id="studentNameDisplay" class="stat-value">N/A</span></div>
        <div class="stat-item"><span>ç”¨æˆ·ID:</span><span id="userIdDisplay" class="stat-value" style="font-size: 9px; word-break: break-all;"></span></div>
        <div class="stat-item"><span>ä¼šè¯ID:</span><span id="sessionIdDisplay" class="stat-value" style="font-size: 9px; word-break: break-all;"></span></div>
        <div class="stat-item"><span>æ³¨è§†ç‚¹æ€»æ•°:</span><span id="totalGazes" class="stat-value">0</span></div>
        <div class="stat-item"><span>çœ¼è·³æ¬¡æ•°:</span><span id="saccadeCount" class="stat-value">0</span></div>
        <div class="stat-item"><span>æ³¨è§†æ¬¡æ•°:</span><span id="fixationCount" class="stat-value">0</span></div>
        <div class="stat-item"><span>å¹³å‡æ³¨è§†æ—¶é—´:</span><span id="avgFixationTime" class="stat-value">0ms</span></div>
        <div class="stat-item"><span>çƒ­åŠ›å›¾å¿«ç…§:</span><span id="heatmapSnapshots" class="stat-value">0</span></div>
        <div class="stat-item"><span>æ•°æ®å¿«ç…§æ•°:</span><span id="snapshotCount" class="stat-value">0</span></div>
        <div class="stat-item"><span>è¿è¡Œæ—¶é—´:</span><span id="runningTime" class="stat-value">0s</span></div>
        <div id="Accuracy">ç­‰å¾…æ ¡å‡†...</div>
        <div class="stat-item"><span>ç³»ç»ŸçŠ¶æ€:</span><span id="systemStatus" class="stat-value">åŠ è½½ä¸­</span></div>
        <div class="collection-status disconnected" id="collectionStatus">ğŸ“ˆ æ•°æ®æ”¶é›†: æœªå¼€å§‹</div>
        <div class="firebase-status disconnected" id="firebaseStatus">ğŸ”¥ Firebase: æœªè¿æ¥</div>
        <button class="btn test" onclick="testFirebaseConnection()" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 10px;">ğŸ§ª æµ‹è¯•è¿æ¥</button>
        <button class="btn test" onclick="forceSaveData()" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 10px;">ğŸ’¾ å¼ºåˆ¶ä¿å­˜</button>
        <button class="btn toggle" onclick="toggleHeatmap()" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 10px;">ğŸ”¥ æ˜¾ç¤º/éšè—çƒ­åŠ›å›¾</button>
        <button class="btn test" onclick="testVideoCapture()" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 10px;">ğŸ“¹ æµ‹è¯•è§†é¢‘æˆªå›¾</button>
        <button class="btn test" onclick="toggleDebug()" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 10px;">ğŸ› æ˜¾ç¤ºè°ƒè¯•</button>
        <button class="btn test" onclick="testOverlayVisibility()" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 10px;">ğŸ‘ï¸ æµ‹è¯•è¦†ç›–å±‚</button>
        <button class="btn test" onclick="testDataCollection()" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 10px;">ğŸ“Š æµ‹è¯•æ•°æ®æ”¶é›†</button>
        <button class="btn test" onclick="testFullscreenCapture()" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 10px;">ğŸ¬ æµ‹è¯•å…¨å±æˆªå›¾</button>
    </div>

    <div id="debugPanel"><div id="debugInfo">è°ƒè¯•ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º...</div></div>
    <div id="heatmapContainer"></div>

    <div class="calibrationDiv">
        <input type="button" class="Calibration" id="Pt1">
        <input type="button" class="Calibration" id="Pt2">
        <input type="button" class="Calibration" id="Pt3">
        <input type="button" class="Calibration" id="Pt4">
        <input type="button" class="Calibration" id="Pt5">
        <input type="button" class="Calibration" id="Pt6">
        <input type="button" class="Calibration" id="Pt7">
        <input type="button" class="Calibration" id="Pt8">
        <input type="button" class="Calibration" id="Pt9">
    </div>

    <div id="content">
        <div class="controls">
            <button class="btn" id="startBtn" onclick="startEyeTracking()" disabled>ğŸš€ å¯åŠ¨çœ¼åŠ¨è¿½è¸ª</button>
            <button class="btn" id="calibrateBtn" onclick="PopUpInstruction()" disabled>ğŸ¯ å¼€å§‹æ ¡å‡†</button>
            <button class="btn" onclick="Restart()">ğŸ”„ é‡æ–°æ ¡å‡†</button>
            <button class="btn" onclick="exportData()">ğŸ“Š å¯¼å‡ºæ•°æ®</button>
        </div>

        <div style="text-align: center; margin: 20px 0; padding: 15px; background: #f2f2f2; border-radius: 8px;">
            <div class="video-container">
                <video
                    id="eyeTrackingVideoPlayer"
                    src="https://res.cloudinary.com/ddp3tohxk/video/upload/v1760346432/%E5%8F%8C%E9%AB%98_a6545s.mp4"
                    width="100%"
                    crossorigin="anonymous"
                    preload="auto"
                    style="border-radius: 8px; background: #000; max-height: 400px;"
                ></video>
                <div id="videoInfoOverlay">
                    ç”¨æˆ·: <span id="overlayUserId"></span> | æ—¶é—´: <span id="overlayTimestamp">0.00s</span>
                </div>
            </div>
            <div style="margin-top: 10px;">
                <button class="btn" id="playVideoBtn" onclick="startVideoExperiment()" style="font-size: 18px; padding: 15px 30px;">â–¶ï¸ å¼€å§‹è§†é¢‘å®éªŒ</button>
            </div>
        </div>

    </div>

    <script>
        // ===========================================
        // å…¨å±€å˜é‡å®šä¹‰
        // ===========================================
        let heatmapInstance = null, gazeCount = 0, snapshotCount = 0, heatmapSnapshotCount = 0, saccadeCount = 0, fixationCount = 0, totalFixationTime = 0;
        let startTime = Date.now();
        let isTracking = false, webgazerReady = false, debugMode = false, librariesLoaded = false, firebaseConnected = false;
        let isCalibrating = false, isVideoExperimentActive = false;

        // æ–°å¢ï¼šç”¨äºå­˜å‚¨å­¦ç”Ÿä¿¡æ¯
        let studentId = null;
        let studentName = null;

        var PointCalibrate = 0;
        var CalibrationPoints = {};

        let eyeTrackingData = { gazePoints: [], saccades: [], fixations: [], heatmapSnapshots: [], calibrationData: { points: [], accuracyPercentage: null, timestamp: null } };

        // ç”¨äºæœ€ç»ˆæœ¬åœ°å¯¼å‡ºçš„ç´¯ç§¯æ•°ç»„
        let sessionGazePoints = [];
        let sessionSaccades = [];
        let sessionFixations = [];

        let persistentHeatmapData = [];
        let allTimeGazePoints = [];

        let lastGazePoint = null, currentFixation = null;
        const fixationThreshold = 50, fixationTimeThreshold = 100;

        let autoSaveInterval = null, heatmapSnapshotInterval = null, statsUpdateInterval = null;

        document.getElementById('sessionIdDisplay').textContent = sessionId;
        document.getElementById('userIdDisplay').textContent = userId;

        document.getElementById('overlayUserId').textContent = userId;

        // ===========================================
        // æ–°å¢ï¼šæ”¶é›†å­¦ç”Ÿä¿¡æ¯çš„åŠŸèƒ½
        // ===========================================
        async function collectStudentInfo() {
            const contentDiv = document.createElement('div');
            contentDiv.innerHTML = `
                <p style="text-align: left; font-weight: bold;">è¯·è¾“å…¥æ‚¨çš„å­¦å·å’Œå§“åå¼€å§‹å®éªŒ:</p>
                <input id="swal-student-id" class="swal-content__input" placeholder="å­¦å· (Student ID)">
                <input id="swal-student-name" class="swal-content__input" placeholder="å§“å (Name)">
            `;

            swal({
                title: "èº«ä»½ä¿¡æ¯",
                content: contentDiv,
                buttons: {
                    confirm: {
                        text: "æäº¤",
                        value: true,
                        visible: true,
                        className: "",
                        closeModal: false,
                    },
                },
                closeOnClickOutside: false,
                closeOnEsc: false,
            }).then(async () => {
                const idInput = document.getElementById('swal-student-id').value.trim();
                const nameInput = document.getElementById('swal-student-name').value.trim();

                if (!idInput || !nameInput) {
                    swal("é”™è¯¯!", "å­¦å·å’Œå§“åä¸èƒ½ä¸ºç©º!", "error");
                    // å»¶è¿Ÿåé‡æ–°å¼¹å‡ºå¯¹è¯æ¡†
                    setTimeout(collectStudentInfo, 1500);
                    return;
                }

                studentId = idInput;
                studentName = nameInput;

                // æ›´æ–°UIæ˜¾ç¤º
                document.getElementById('studentIdDisplay').textContent = studentId;
                document.getElementById('studentNameDisplay').textContent = studentName;

                // å…³é—­å½“å‰å¼¹çª—
                swal.stopLoading();
                swal.close();

                // ç«‹å³ä¿å­˜å­¦ç”Ÿä¿¡æ¯åˆ°Firebase
                await saveStudentInfoToFirebase();

                // ç»§ç»­åŸæœ‰çš„ç³»ç»Ÿåˆå§‹åŒ–æµç¨‹
                await initializeSystem();
            });
        }

        async function saveStudentInfoToFirebase() {
            debug(`æ­£åœ¨ä¿å­˜å­¦ç”Ÿä¿¡æ¯: ${studentId} - ${studentName}`);
            try {
                await db.collection("student_info_video_v1").add({
                    studentId,
                    studentName,
                    userId,
                    sessionId,
                    timestamp: new Date().toISOString(),
                    experimentType: 'video_eye_tracking'
                });
                debug('å­¦ç”Ÿä¿¡æ¯æˆåŠŸä¿å­˜åˆ°Firebaseã€‚');
                swal('ä¿¡æ¯å·²è®°å½•', `å­¦å·: ${studentId}\nå§“å: ${studentName}`, 'success', { timer: 2000 });
            } catch (error) {
                console.error("ä¿å­˜å­¦ç”Ÿä¿¡æ¯å¤±è´¥: ", error);
                debug(`ä¿å­˜å­¦ç”Ÿä¿¡æ¯å¤±è´¥: ${error.message}`);
                swal('ä¿å­˜å¤±è´¥', 'æ— æ³•è®°å½•æ‚¨çš„ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å¹¶åˆ·æ–°é¡µé¢ã€‚', 'error');
            }
        }

        // ===========================================
        // æ ¸å¿ƒç³»ç»Ÿå‡½æ•°
        // ===========================================
        function debug(message) {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[DEBUG ${timestamp}] ${message}`);
            if (debugMode) {
                const debugDiv = document.getElementById('debugInfo');
                debugDiv.innerHTML = `[${timestamp}] ${message}<br>` + debugDiv.innerHTML.split('<br>').slice(0, 30).join('<br>');
            }
        }
        function updateStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            document.getElementById('systemStatus').textContent = message;
            debug(`çŠ¶æ€æ›´æ–°: ${message}`);
        }
        function updateFirebaseStatus(message, status) {
            const el = document.getElementById('firebaseStatus');
            el.textContent = `ğŸ”¥ Firebase: ${message}`;
            el.className = `firebase-status ${status}`;
        }
        function updateCollectionStatus(message, status) {
            const el = document.getElementById('collectionStatus');
            el.textContent = `ğŸ“ˆ æ•°æ®æ”¶é›†: ${message}`;
            el.className = `collection-status ${status}`;
        }

        async function testFirebaseConnection() {
            debug('å¼€å§‹æµ‹è¯•Firebaseè¿æ¥...');
            updateFirebaseStatus('æµ‹è¯•ä¸­...', 'uploading');
            try {
                await db.collection("video_experiment_connection_test_v1").add({
                    sessionId,
                    userId,
                    studentId, // æ·»åŠ å­¦ç”Ÿä¿¡æ¯
                    studentName, // æ·»åŠ å­¦ç”Ÿä¿¡æ¯
                    timestamp: new Date().toISOString(),
                    experimentType: 'video_eye_tracking'
                });
                debug('Firebaseè¿æ¥æµ‹è¯•æˆåŠŸï¼');
                updateFirebaseStatus('è¿æ¥æ­£å¸¸', 'connected');
                firebaseConnected = true;
                swal('æˆåŠŸ', `Firebaseè¿æ¥æµ‹è¯•æˆåŠŸï¼\nç”¨æˆ·ID: ${userId}`, 'success');
            } catch (error) {
                console.error("Firebase Connection Test Failed: ", error);
                debug(`Firebaseè¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`);
                updateFirebaseStatus('è¿æ¥å¤±è´¥', 'disconnected');
                firebaseConnected = false;
                swal('å¤±è´¥', `Firebaseè¿æ¥æµ‹è¯•å¤±è´¥ï¼\n\n${error.message}`, 'error');
            }
        }
        async function forceSaveData() {
            if (!isTracking) return swal('æç¤º', 'è¯·å…ˆå¯åŠ¨çœ¼åŠ¨è¿½è¸ªã€‚', 'info');
            await saveEyeTrackingData(true);
        }

        // ===========================================
        // è§†é¢‘å¤„ç†é€»è¾‘
        // ===========================================
        function setupVideoPlayer() {
            const videoPlayer = document.getElementById('eyeTrackingVideoPlayer');

            videoPlayer.controls = false;
            videoPlayer.controlsList = "nodownload nofullscreen noremoteplayback";
            videoPlayer.disablePictureInPicture = true;

            videoPlayer.addEventListener('loadedmetadata', () => {
                debug(`è§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆ: ${videoPlayer.videoWidth}x${videoPlayer.videoHeight}`);
            });

            videoPlayer.addEventListener('canplay', () => {
                debug('è§†é¢‘å¯ä»¥å¼€å§‹æ’­æ”¾');
            });

            videoPlayer.addEventListener('error', (e) => {
                debug(`è§†é¢‘åŠ è½½é”™è¯¯: ${e.message}`);
            });

            videoPlayer.onplay = () => {
                debug(`è§†é¢‘å¼€å§‹æ’­æ”¾ï¼Œå½“å‰æ—¶é—´: ${videoPlayer.currentTime.toFixed(2)}s`);
                isVideoExperimentActive = true;
                startVideoInfoUpdate();
                debug(`isVideoExperimentActive è®¾ç½®ä¸º: ${isVideoExperimentActive}`);
            };

            videoPlayer.onpause = () => {
                debug(`è§†é¢‘å·²æš‚åœï¼Œå½“å‰æ—¶é—´: ${videoPlayer.currentTime.toFixed(2)}s`);
                isVideoExperimentActive = false;
                stopVideoInfoUpdate();
                debug(`isVideoExperimentActive è®¾ç½®ä¸º: ${isVideoExperimentActive}`);
            };
            
            // =======================================================================
            // ==================== æ ¸å¿ƒä¿®æ”¹éƒ¨åˆ† (START) =============================
            // =======================================================================
            // æ­¤å¤„ä¸ºä¿®æ”¹åçš„ onended äº‹ä»¶å¤„ç†å™¨ï¼Œç”¨äºè§£å†³ç«æ€æ¡ä»¶é—®é¢˜
            videoPlayer.onended = () => {
                debug('è§†é¢‘æ’­æ”¾ç»“æŸï¼Œç«‹å³å†»ç»“æ•°æ®çŠ¶æ€ä»¥å‡†å¤‡æœ€ç»ˆå¯¼å‡ºã€‚');

                // --- å…³é”®ä¿®æ”¹ï¼šç«‹å³åœæ­¢æ‰€æœ‰æ•°æ®æ”¶é›†å’Œå®šæ—¶å™¨ï¼Œæ¶ˆé™¤ç«æ€æ¡ä»¶ ---
                isTracking = false; // åœæ­¢æ–°æ•°æ®çš„ gazeDataCallback å¤„ç†
                isVideoExperimentActive = false; // æ›´æ–°çŠ¶æ€
                stopAutoSave(); // åœæ­¢è‡ªåŠ¨ä¿å­˜å®šæ—¶å™¨
                stopHeatmapSnapshots(); // åœæ­¢çƒ­åŠ›å›¾å¿«ç…§å®šæ—¶å™¨
                stopStatsUpdate(); // åœæ­¢ç»Ÿè®¡æ›´æ–°
                if (typeof webgazer !== 'undefined' && webgazer.isReady()) {
                    webgazer.pause(); // æš‚åœWebGazerï¼Œåœæ­¢ç”Ÿæˆæ–°çš„çœ¼åŠ¨æ•°æ®
                    debug("WebGazer å·²æš‚åœã€‚");
                }
                // -----------------------------------------------------------

                stopVideoInfoUpdate();
                exitFullscreen();

                swal('å®éªŒç»“æŸ', 'è§†é¢‘æ’­æ”¾å·²å®Œæˆã€‚æ­£åœ¨å¤„ç†å¹¶ä¿å­˜æœ€ç»ˆæ•°æ®ï¼Œè¯·ç¨å€™...', 'success', {
                    buttons: false,
                    timer: 5000, // å¢åŠ ä¸€ç‚¹æ—¶é—´ç»™æ•°æ®å¤„ç†
                    closeOnClickOutside: false,
                    closeOnEsc: false,
                });

                // å¼‚æ­¥æ‰§è¡Œæœ€ç»ˆä¿å­˜æµç¨‹ï¼Œç¡®ä¿é¡ºåºæ­£ç¡®
                (async () => {
                    try {
                        debug('å¼€å§‹æœ€ç»ˆæ•°æ®ä¿å­˜æµç¨‹...');
                        // 1. å¼ºåˆ¶å°†å†…å­˜ä¸­å‰©ä½™çš„æœ€åä¸€éƒ¨åˆ†æ•°æ®ä¿å­˜åˆ°Firebase
                        await saveEyeTrackingData(true);
                        debug('æœ€ç»ˆFirebaseæ•°æ®ä¿å­˜å®Œæˆã€‚');

                        // 2. ä¿å­˜/æ˜¾ç¤ºæ‰€æœ‰çƒ­åŠ›å›¾
                        saveAllHeatmaps();
                        debug('æ‰€æœ‰çƒ­åŠ›å›¾å¤„ç†å®Œæˆã€‚');

                        // 3. ç¨ä½œå»¶è¿Ÿï¼Œç„¶åæç¤ºç”¨æˆ·ä¸‹è½½æœ¬åœ°Excelæ–‡ä»¶
                        await sleep(4000); // ç­‰å¾…ä¹‹å‰çš„æç¤ºæ¡†æ¶ˆå¤±

                        debug('å‡†å¤‡æç¤ºç”¨æˆ·è¿›è¡Œæœ¬åœ°æ•°æ®ä¸‹è½½ã€‚');
                        swal({
                            title: 'æ•°æ®æœ¬åœ°ä¸‹è½½',
                            text: 'å®éªŒæœŸé—´çš„çœ¼åŠ¨æ•°æ®å°†ç”Ÿæˆä¸€ä¸ªExcelæ–‡ä»¶ä¾›æ‚¨ä¸‹è½½ã€‚',
                            icon: 'info',
                            button: 'å¥½çš„ï¼Œå¼€å§‹ä¸‹è½½',
                            closeOnClickOutside: false,
                            closeOnEsc: false,
                        }).then(() => {
                            saveLocalData(); // è°ƒç”¨æœ¬åœ°ä¿å­˜å‡½æ•°
                        });
                    } catch (error) {
                        console.error("æœ€ç»ˆæ•°æ®å¤„ç†æµç¨‹å‡ºé”™: ", error);
                        debug(`æœ€ç»ˆæ•°æ®å¤„ç†æµç¨‹å‡ºé”™: ${error.message}`);
                        swal('å¤„ç†å‡ºé”™', 'åœ¨å¤„ç†æœ€ç»ˆæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯ã€‚', 'error');
                    }
                })();
            };
            // =======================================================================
            // ==================== æ ¸å¿ƒä¿®æ”¹éƒ¨åˆ† (END) ===============================
            // =======================================================================


            videoPlayer.addEventListener('seeking', (e) => {
                if (isVideoExperimentActive) {
                    e.preventDefault();
                    debug('é˜»æ­¢ç”¨æˆ·æ‹–åŠ¨è¿›åº¦æ¡');
                }
            });

            videoPlayer.addEventListener('contextmenu', (e) => {
                e.preventDefault();
            });

            debug("è§†é¢‘æ’­æ”¾å™¨å·²å‡†å¤‡å°±ç»ªã€‚");
        }

        // ===========================================
        // æ–°å¢åŠŸèƒ½ï¼šåœ¨æµ‹è¯•ç«¯ä¿å­˜æ‰€æœ‰çƒ­åŠ›å›¾
        // ===========================================
        function saveAllHeatmaps() {
            debug(`å¼€å§‹ä¿å­˜æ‰€æœ‰çƒ­åŠ›å›¾ï¼Œå…± ${eyeTrackingData.heatmapSnapshots.length} å¼ `);
            if (eyeTrackingData.heatmapSnapshots.length === 0) {
                swal('æ— çƒ­åŠ›å›¾', 'æœ¬æ¬¡å®éªŒæ²¡æœ‰ç”Ÿæˆä»»ä½•çƒ­åŠ›å›¾å¿«ç…§ã€‚', 'info');
                return;
            }

            // åˆ›å»ºä¸€ä¸ªæ–°çª—å£æ¥å±•ç¤ºæ‰€æœ‰å›¾ç‰‡
            const newWindow = window.open('', '_blank');
            newWindow.document.write('<html><head><title>çƒ­åŠ›å›¾ç»“æœ</title><style>body { font-family: sans-serif; text-align: center; } img { max-width: 45%; margin: 10px; border: 2px solid #ccc; cursor: pointer; transition: transform 0.2s; } img:hover { transform: scale(1.02); } h1 { text-align: center; } </style></head><body>');
            newWindow.document.write(`<h1>å…± ${eyeTrackingData.heatmapSnapshots.length} å¼ çƒ­åŠ›å›¾ (ç‚¹å‡»å›¾ç‰‡å¯åœ¨æ–°æ ‡ç­¾é¡µä¸­æŸ¥çœ‹å¤§å›¾)</h1>`);

            // éå†æ‰€æœ‰å¿«ç…§é“¾æ¥ï¼Œå¹¶åœ¨æ–°çª—å£ä¸­åˆ›å»ºå›¾ç‰‡å…ƒç´ 
            eyeTrackingData.heatmapSnapshots.forEach((snapshot, index) => {
                const imageUrl = snapshot.storageUrl;
                const fileName = snapshot.fileName || `heatmap_${index + 1}.png`;
                // *** æ ¸å¿ƒä¿®æ”¹ç‚¹ï¼šå¢åŠ äº† target="_blank" ***
                newWindow.document.write(`<a href="${imageUrl}" target="_blank" download="${fileName}"><img src="${imageUrl}" alt="${fileName}"></a>`);
            });

            newWindow.document.write('</body></html>');
            newWindow.document.close();

            swal('æ“ä½œå®Œæˆ', 'æ‰€æœ‰çƒ­åŠ›å›¾å·²åœ¨æ–°çª—å£ä¸­æ‰“å¼€ï¼Œæ‚¨å¯ä»¥ç›´æ¥ç‚¹å‡»å›¾ç‰‡è¿›è¡ŒæŸ¥çœ‹æˆ–å³é”®ä¿å­˜ã€‚', 'success');
        }


        let videoInfoInterval = null;

        function startVideoInfoUpdate() {
            if (videoInfoInterval) clearInterval(videoInfoInterval);
            videoInfoInterval = setInterval(updateVideoInfo, 100);
        }

        function stopVideoInfoUpdate() {
            if (videoInfoInterval) {
                clearInterval(videoInfoInterval);
                videoInfoInterval = null;
            }
        }

        function updateVideoInfo() {
            const videoPlayer = document.getElementById('eyeTrackingVideoPlayer');
            const timestampElement = document.getElementById('overlayTimestamp');
            if (videoPlayer && timestampElement) {
                timestampElement.textContent = videoPlayer.currentTime.toFixed(2) + 's';
            }
        }

        async function startVideoExperiment() {
            if (!isTracking) {
                swal('æç¤º', 'è¯·å…ˆå¯åŠ¨çœ¼åŠ¨è¿½è¸ªç³»ç»Ÿï¼', 'warning');
                return;
            }

            if (!webgazerReady) {
                swal('æç¤º', 'è¯·ç­‰å¾…çœ¼åŠ¨è¿½è¸ªç³»ç»Ÿå‡†å¤‡å°±ç»ªï¼', 'warning');
                return;
            }

            const videoPlayer = document.getElementById('eyeTrackingVideoPlayer');
            const playBtn = document.getElementById('playVideoBtn');

            try {
                videoPlayer.currentTime = 0;
                await videoPlayer.play();
                debug('è§†é¢‘å¼€å§‹æ’­æ”¾ï¼Œå‡†å¤‡è¿›å…¥å…¨å±');

                setTimeout(async () => {
                    try {
                        await enterFullscreen(videoPlayer);
                        debug('å·²æˆåŠŸè¿›å…¥å…¨å±æ¨¡å¼');
                    } catch (error) {
                        debug(`å…¨å±å¤±è´¥ï¼Œç»§ç»­éå…¨å±æ¨¡å¼: ${error.message}`);
                    }
                }, 100);

                playBtn.textContent = 'ğŸ¬ å®éªŒè¿›è¡Œä¸­...';
                playBtn.disabled = true;

                isVideoExperimentActive = true;
                debug('è§†é¢‘å®éªŒå·²å¼€å§‹ï¼Œå¼€å§‹è®°å½•çœ¼åŠ¨æ•°æ®');

            } catch (error) {
                console.error('å¯åŠ¨è§†é¢‘å®éªŒå¤±è´¥:', error);
                debug(`å¯åŠ¨è§†é¢‘å®éªŒå¤±è´¥: ${error.message}`);
                swal('é”™è¯¯', 'æ— æ³•å¯åŠ¨è§†é¢‘å®éªŒï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™ï¼', 'error');
            }
        }

        async function enterFullscreen(element) {
            try {
                if (element.requestFullscreen) {
                    await element.requestFullscreen();
                } else if (element.webkitRequestFullscreen) {
                    await element.webkitRequestFullscreen();
                } else if (element.msRequestFullscreen) {
                    await element.msRequestFullscreen();
                }
                debug('å·²è¿›å…¥å…¨å±æ¨¡å¼');

                setTimeout(() => {
                    updateHeatmapForFullscreen();
                }, 500);

            } catch (error) {
                debug(`å…¨å±æ¨¡å¼å¤±è´¥: ${error.message}`);
                throw error;
            }
        }

        function updateHeatmapForFullscreen() {
            if (heatmapInstance) {
                debug(`æ›´æ–°çƒ­åŠ›å›¾é…ç½®ä¸ºå…¨å±å°ºå¯¸: ${window.innerWidth}x${window.innerHeight}`);

                const heatmapContainer = document.getElementById('heatmapContainer');
                heatmapContainer.style.width = window.innerWidth + 'px';
                heatmapContainer.style.height = window.innerHeight + 'px';

                heatmapInstance = h337.create({
                    container: heatmapContainer,
                    radius: Math.max(25, window.innerWidth / 50),
                    maxOpacity: 0.7,
                    minOpacity: 0.1,
                    blur: 0.8
                });

                debug('çƒ­åŠ›å›¾å·²æ›´æ–°ä¸ºå…¨å±é…ç½®');
            }
        }

        function exitFullscreen() {
            try {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }

                const playBtn = document.getElementById('playVideoBtn');
                playBtn.textContent = 'â–¶ï¸ å¼€å§‹è§†é¢‘å®éªŒ';
                playBtn.disabled = false;

                debug('å·²é€€å‡ºå…¨å±æ¨¡å¼');
            } catch (error) {
                debug(`é€€å‡ºå…¨å±å¤±è´¥: ${error.message}`);
            }
        }

        function testVideoCapture() {
            const video = document.getElementById('eyeTrackingVideoPlayer');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = video.videoWidth || video.offsetWidth;
            canvas.height = video.videoHeight || video.offsetHeight;

            try {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const dataURL = canvas.toDataURL('image/png');

                const win = window.open();
                win.document.write(`<img src="${dataURL}" style="max-width: 100%;">`);
                debug('è§†é¢‘æˆªå›¾æµ‹è¯•æˆåŠŸ');
                return true;
            } catch (e) {
                debug(`è§†é¢‘æˆªå›¾æµ‹è¯•å¤±è´¥: ${e.message}`);
                return false;
            }
        }

        function testOverlayVisibility() {
            const videoInfoOverlay = document.getElementById('videoInfoOverlay');
            const currentVisibility = videoInfoOverlay.style.visibility;

            debug(`å½“å‰è¦†ç›–å±‚å¯è§æ€§: ${currentVisibility}`);

            if (currentVisibility === 'hidden' || currentVisibility === '') {
                videoInfoOverlay.style.visibility = 'visible';
                updateVideoInfo();
                debug('è¦†ç›–å±‚å·²æ˜¾ç¤ºç”¨äºæµ‹è¯•');
                setTimeout(() => {
                    videoInfoOverlay.style.visibility = 'hidden';
                    debug('è¦†ç›–å±‚å·²é‡æ–°éšè—');
                }, 3000);
            } else {
                videoInfoOverlay.style.visibility = 'hidden';
                debug('è¦†ç›–å±‚å·²éšè—');
            }
        }

        function testDataCollection() {
            debug('å¼€å§‹æµ‹è¯•æ•°æ®æ”¶é›†åŠŸèƒ½...');

            const videoPlayer = document.getElementById('eyeTrackingVideoPlayer');
            const currentTime = videoPlayer.currentTime || 5.25;

            debug(`å½“å‰è§†é¢‘æ—¶é—´: ${currentTime.toFixed(4)}s`);

            for (let i = 0; i < 20; i++) {
                const videoTimestamp = parseFloat((currentTime + i * 0.1).toFixed(4));
                const testGazePoint = {
                    x: 500 + i * 15 + Math.random() * 30,
                    y: 300 + i * 8 + Math.random() * 20,
                    timestamp: new Date().toISOString(),
                    elapsedTime: Date.now() - startTime,
                    sessionId,
                    userId,
                    videoTimestamp: videoTimestamp,
                    relativeX: 400 + i * 15,
                    relativeY: 200 + i * 8,
                    isVideoActive: true
                };

                eyeTrackingData.gazePoints.push(testGazePoint);
                sessionGazePoints.push(testGazePoint); // åŒæ—¶æ¨é€åˆ°ä¼šè¯æ•°æ®ä»¥ä¾›æµ‹è¯•
                allTimeGazePoints.push({
                    x: testGazePoint.x,
                    y: testGazePoint.y,
                    timestamp: testGazePoint.timestamp,
                    videoTimestamp: testGazePoint.videoTimestamp,
                    isVideoActive: testGazePoint.isVideoActive
                });

                if (heatmapInstance) {
                    heatmapInstance.addData({ x: testGazePoint.x, y: testGazePoint.y, value: 5 });
                }

                gazeCount++;

                debug(`æµ‹è¯•ç‚¹ ${i}: videoTimestamp=${videoTimestamp}s`);
            }

            updateStatsDisplay();
            debug(`æµ‹è¯•æ•°æ®å·²æ·»åŠ  - æ³¨è§†ç‚¹: ${eyeTrackingData.gazePoints.length}, ç´¯ç§¯çƒ­åŠ›å›¾ç‚¹æ•°: ${allTimeGazePoints.length}`);

            const latestGazePoint = eyeTrackingData.gazePoints[eyeTrackingData.gazePoints.length - 1];
            const latestHeatmapPoint = allTimeGazePoints[allTimeGazePoints.length - 1];
            debug(`æœ€æ–°æ³¨è§†ç‚¹videoTimestamp: ${latestGazePoint.videoTimestamp}s`);
            debug(`æœ€æ–°çƒ­åŠ›å›¾ç‚¹videoTimestamp: ${latestHeatmapPoint.videoTimestamp}s`);

            saveEyeTrackingData(true);

            swal('æµ‹è¯•å®Œæˆ', `å·²æ·»åŠ æµ‹è¯•æ•°æ®ï¼š\næ³¨è§†ç‚¹: ${eyeTrackingData.gazePoints.length}\nç´¯ç§¯çƒ­åŠ›å›¾ç‚¹æ•°: ${allTimeGazePoints.length}\nå½“å‰è§†é¢‘æ—¶é—´: ${currentTime.toFixed(4)}s`, 'info');
        }

        function testFullscreenCapture() {
            const isFullscreen = document.fullscreenElement !== null ||
                               document.webkitFullscreenElement !== null ||
                               document.mozFullScreenElement !== null ||
                               document.msFullscreenElement !== null;

            if (!isFullscreen) {
                swal('æç¤º', 'è¯·å…ˆè¿›å…¥å…¨å±æ¨¡å¼ï¼ˆç‚¹å‡»"å¼€å§‹è§†é¢‘å®éªŒ"æŒ‰é’®ï¼‰å†æµ‹è¯•æˆªå›¾åŠŸèƒ½', 'info');
                return;
            }

            debug('å¼€å§‹æµ‹è¯•å…¨å±æˆªå›¾åŠŸèƒ½...');

            if (heatmapInstance && isTracking && isVideoExperimentActive) {
                captureHeatmapSnapshot();
                swal('æµ‹è¯•', 'å·²è§¦å‘å…¨å±çƒ­åŠ›å›¾æˆªå›¾ï¼Œè¯·æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯å’ŒCloudinary', 'info');
            } else {
                swal('é”™è¯¯', 'è¯·ç¡®ä¿çœ¼åŠ¨è¿½è¸ªå·²å¯åŠ¨ä¸”è§†é¢‘å®éªŒæ­£åœ¨è¿›è¡Œ', 'error');
            }
        }

        // ===========================================
        // çœ¼åŠ¨æ•°æ®å¤„ç†
        // ===========================================
        function gazeDataCallback(data, elapsedTime) {
            if (isCalibrating || !data || typeof data.x !== 'number' || typeof data.y !== 'number' || isNaN(data.x) || isNaN(data.y) || data.x < 0 || data.y < 0) return;

            if (!isTracking) return;

            const timestamp = new Date().toISOString();
            const videoPlayer = document.getElementById('eyeTrackingVideoPlayer');
            const isFullscreen = document.fullscreenElement !== null ||
                               document.webkitFullscreenElement !== null ||
                               document.mozFullScreenElement !== null ||
                               document.msFullscreenElement !== null;

            let gazePoint = {
                x: Math.floor(data.x),
                y: Math.floor(data.y),
                timestamp,
                elapsedTime: elapsedTime || Date.now() - startTime,
                sessionId,
                userId,
                videoTimestamp: null,
                relativeX: null,
                relativeY: null,
                isVideoActive: isVideoExperimentActive,
                isFullscreen: isFullscreen
            };

            if (videoPlayer && !videoPlayer.paused && videoPlayer.currentTime > 0 && isVideoExperimentActive) {
                gazePoint.videoTimestamp = parseFloat(videoPlayer.currentTime.toFixed(4));

                if (isFullscreen) {
                    gazePoint.relativeX = gazePoint.x;
                    gazePoint.relativeY = gazePoint.y;
                } else {
                    const videoRect = videoPlayer.getBoundingClientRect();
                    const relX = gazePoint.x - videoRect.left;
                    const relY = gazePoint.y - videoRect.top;

                    if (relX >= 0 && relX <= videoRect.width && relY >= 0 && relY <= videoRect.height) {
                        gazePoint.relativeX = Math.floor(relX);
                        gazePoint.relativeY = Math.floor(relY);
                    }
                }

                if (gazeCount % 100 === 0) {
                    debug(`è®°å½•æ³¨è§†ç‚¹: x=${gazePoint.x}, y=${gazePoint.y}, è§†é¢‘æ—¶é—´=${gazePoint.videoTimestamp}s, å…¨å±=${isFullscreen}`);

                    const currentVideoTime = videoPlayer.currentTime;
                    const timeDiff = Math.abs(gazePoint.videoTimestamp - currentVideoTime);
                    if (timeDiff > 0.1) {
                        debug(`âš ï¸ VideoTimestampä¸ä¸€è‡´è­¦å‘Š: æ³¨è§†ç‚¹æ—¶é—´=${gazePoint.videoTimestamp}s, å½“å‰è§†é¢‘æ—¶é—´=${currentVideoTime.toFixed(4)}s, å·®å¼‚=${timeDiff.toFixed(4)}s`);
                    }
                }
            } else {
                if (gazeCount % 100 === 0) {
                    debug(`è®°å½•éè§†é¢‘æ³¨è§†ç‚¹: x=${gazePoint.x}, y=${gazePoint.y}, æ— è§†é¢‘æ—¶é—´æˆ³`);
                }
            }

            processSaccadeAndFixation(gazePoint);
            eyeTrackingData.gazePoints.push(gazePoint);
            sessionGazePoints.push(gazePoint); // å­˜å‚¨åˆ°ç”¨äºæœ¬åœ°å¯¼å‡ºçš„ç´¯ç§¯æ•°ç»„

            allTimeGazePoints.push({
                x: gazePoint.x,
                y: gazePoint.y,
                timestamp: gazePoint.timestamp,
                videoTimestamp: gazePoint.videoTimestamp,
                isVideoActive: gazePoint.isVideoActive
            });

            if (heatmapInstance) {
                heatmapInstance.addData({ x: gazePoint.x, y: gazePoint.y, value: 5 });
                if (gazeCount % 200 === 0) {
                    debug(`çƒ­åŠ›å›¾æ•°æ®ç‚¹å·²æ·»åŠ : ${allTimeGazePoints.length} æ€»ç‚¹æ•°`);
                }
            }

            gazeCount++;
            if (gazeCount % 50 === 0) {
                updateStatsDisplay();
                debug(`å·²è®°å½• ${gazeCount} ä¸ªæ³¨è§†ç‚¹ï¼Œçƒ­åŠ›å›¾ç´¯ç§¯ç‚¹æ•°: ${allTimeGazePoints.length}`);
            }
        }

        function processSaccadeAndFixation(gazePoint) {
            if (isCalibrating) return;

            if (!lastGazePoint) {
                lastGazePoint = gazePoint;
                currentFixation = {
                    startPoint: {...gazePoint},
                    startTime: gazePoint.timestamp,
                    pointCount: 1,
                    sessionId,
                    userId,
                    isVideoActive: isVideoExperimentActive,
                    videoTimestamp: gazePoint.videoTimestamp
                };
                return;
            }
            const distance = Math.sqrt(Math.pow(gazePoint.x - lastGazePoint.x, 2) + Math.pow(gazePoint.y - lastGazePoint.y, 2));
            if (distance > fixationThreshold) {
                if (currentFixation && currentFixation.pointCount > 1) {
                    const duration = new Date(gazePoint.timestamp).getTime() - new Date(currentFixation.startTime).getTime();
                    if (duration > fixationTimeThreshold) {
                        currentFixation.duration = duration;
                        currentFixation.endPoint = {...lastGazePoint};
                        currentFixation.centerPoint = {
                            x: Math.round((currentFixation.startPoint.x + currentFixation.endPoint.x) / 2),
                            y: Math.round((currentFixation.startPoint.y + currentFixation.endPoint.y) / 2)
                        };
                        currentFixation.endVideoTimestamp = lastGazePoint.videoTimestamp;
                        const fixationData = {...currentFixation};
                        eyeTrackingData.fixations.push(fixationData);
                        sessionFixations.push(fixationData); // å­˜å‚¨åˆ°ç”¨äºæœ¬åœ°å¯¼å‡ºçš„ç´¯ç§¯æ•°ç»„
                        fixationCount++;
                        totalFixationTime += duration;
                    }
                }
                const saccadeDuration = new Date(gazePoint.timestamp).getTime() - new Date(lastGazePoint.timestamp).getTime();
                const saccadeData = {
                    startPoint: {...lastGazePoint},
                    endPoint: {...gazePoint},
                    distance: Math.round(distance),
                    duration: saccadeDuration,
                    velocity: saccadeDuration > 0 ? Math.round(distance / saccadeDuration * 1000) : 0,
                    sessionId,
                    userId,
                    isVideoActive: isVideoExperimentActive,
                    startVideoTimestamp: lastGazePoint.videoTimestamp,
                    endVideoTimestamp: gazePoint.videoTimestamp
                };
                eyeTrackingData.saccades.push(saccadeData);
                sessionSaccades.push(saccadeData); // å­˜å‚¨åˆ°ç”¨äºæœ¬åœ°å¯¼å‡ºçš„ç´¯ç§¯æ•°ç»„
                saccadeCount++;
                currentFixation = {
                    startPoint: {...gazePoint},
                    startTime: gazePoint.timestamp,
                    pointCount: 1,
                    sessionId,
                    userId,
                    isVideoActive: isVideoExperimentActive,
                    videoTimestamp: gazePoint.videoTimestamp
                };
            } else {
                if (currentFixation) currentFixation.pointCount++;
            }
            lastGazePoint = gazePoint;
        }

        function updateStatsDisplay() {
            document.getElementById('totalGazes').textContent = gazeCount;
            document.getElementById('saccadeCount').textContent = saccadeCount;
            document.getElementById('fixationCount').textContent = fixationCount;
            document.getElementById('heatmapSnapshots').textContent = heatmapSnapshotCount;
            document.getElementById('snapshotCount').textContent = snapshotCount;
            document.getElementById('avgFixationTime').textContent = (fixationCount > 0 ? Math.round(totalFixationTime / fixationCount) : 0) + 'ms';
        }

        function startHeatmapSnapshots() {
            if (heatmapSnapshotInterval) clearInterval(heatmapSnapshotInterval);
            heatmapSnapshotInterval = setInterval(() => {
                if (heatmapInstance && isTracking && allTimeGazePoints.length > 0) {
                    captureHeatmapSnapshot();
                }
            }, 2000);
            debug('çƒ­åŠ›å›¾å¿«ç…§å®šæ—¶å™¨å·²å¯åŠ¨ï¼Œæ¯2ç§’æ•è·ä¸€æ¬¡');
        }

        function stopHeatmapSnapshots() { if (heatmapSnapshotInterval) clearInterval(heatmapSnapshotInterval); }

        async function captureHeatmapSnapshot() {
            const heatmapContainer = document.getElementById('heatmapContainer');
            const videoInfoOverlay = document.getElementById('videoInfoOverlay');
            const originalVisibility = heatmapContainer.style.visibility;
            const originalOverlayVisibility = videoInfoOverlay.style.visibility;

            try {
                const isFullscreen = document.fullscreenElement !== null ||
                                   document.webkitFullscreenElement !== null ||
                                   document.mozFullScreenElement !== null ||
                                   document.msFullscreenElement !== null;

                debug(`çƒ­åŠ›å›¾å¿«ç…§æ•è·å¼€å§‹ - å…¨å±: ${isFullscreen}, ç´¯ç§¯ç‚¹æ•°: ${allTimeGazePoints.length}`);

                const originalVideo = document.getElementById('eyeTrackingVideoPlayer');
                const currentVideoTime = originalVideo.currentTime || 0;

                const heatmapPointsWithVideoTime = allTimeGazePoints.filter(point => point.videoTimestamp !== null);
                debug(`ğŸ“Š çƒ­åŠ›å›¾éªŒè¯ - æ€»ç‚¹æ•°: ${allTimeGazePoints.length}, æœ‰è§†é¢‘æ—¶é—´æˆ³: ${heatmapPointsWithVideoTime.length}`);

                if (heatmapPointsWithVideoTime.length > 0) {
                    const minVideoTime = Math.min(...heatmapPointsWithVideoTime.map(p => p.videoTimestamp));
                    const maxVideoTime = Math.max(...heatmapPointsWithVideoTime.map(p => p.videoTimestamp));
                    debug(`ğŸ“Š çƒ­åŠ›å›¾è§†é¢‘æ—¶é—´æˆ³èŒƒå›´: ${minVideoTime.toFixed(4)}s - ${maxVideoTime.toFixed(4)}s`);
                    debug(`ğŸ“Š å½“å‰æˆªå›¾è§†é¢‘æ—¶é—´: ${currentVideoTime.toFixed(4)}s`);

                    if (currentVideoTime < minVideoTime || currentVideoTime > maxVideoTime + 1) {
                        debug(`âš ï¸ æ—¶é—´æˆ³ä¸ä¸€è‡´è­¦å‘Š: æˆªå›¾æ—¶é—´=${currentVideoTime.toFixed(4)}s ä¸åœ¨çƒ­åŠ›å›¾æ•°æ®èŒƒå›´å†…`);
                    }
                }

                const screenshotCanvas = document.createElement('canvas');
                const screenshotCtx = screenshotCanvas.getContext('2d');

                if (isFullscreen) {
                    screenshotCanvas.width = window.innerWidth;
                    screenshotCanvas.height = window.innerHeight;
                } else {
                    screenshotCanvas.width = Math.max(1920, window.innerWidth);
                    screenshotCanvas.height = Math.max(1080, window.innerHeight);
                }

                debug(`æˆªå›¾Canvaså°ºå¯¸: ${screenshotCanvas.width}x${screenshotCanvas.height}`);

                screenshotCtx.fillStyle = isFullscreen ? '#000000' : '#f0f0f0';
                screenshotCtx.fillRect(0, 0, screenshotCanvas.width, screenshotCanvas.height);

                if (originalVideo && !originalVideo.paused && originalVideo.videoWidth > 0 && originalVideo.videoHeight > 0) {
                    const videoAspect = originalVideo.videoWidth / originalVideo.videoHeight;
                    const screenAspect = screenshotCanvas.width / screenshotCanvas.height;

                    let drawWidth, drawHeight, drawX, drawY;

                    if (videoAspect > screenAspect) {
                        drawWidth = screenshotCanvas.width;
                        drawHeight = screenshotCanvas.width / videoAspect;
                        drawX = 0;
                        drawY = (screenshotCanvas.height - drawHeight) / 2;
                    } else {
                        drawHeight = screenshotCanvas.height;
                        drawWidth = screenshotCanvas.height * videoAspect;
                        drawX = (screenshotCanvas.width - drawWidth) / 2;
                        drawY = 0;
                    }

                    debug(`è§†é¢‘ç»˜åˆ¶åŒºåŸŸ: ${drawX}, ${drawY}, ${drawWidth}x${drawHeight}`);

                    screenshotCtx.drawImage(originalVideo, drawX, drawY, drawWidth, drawHeight);
                } else {
                    screenshotCtx.fillStyle = '#333333';
                    const placeholderWidth = Math.min(screenshotCanvas.width * 0.8, 800);
                    const placeholderHeight = Math.min(screenshotCanvas.height * 0.6, 600);
                    const placeholderX = (screenshotCanvas.width - placeholderWidth) / 2;
                    const placeholderY = (screenshotCanvas.height - placeholderHeight) / 2;
                    screenshotCtx.fillRect(placeholderX, placeholderY, placeholderWidth, placeholderHeight);
                    screenshotCtx.fillStyle = '#FFFFFF';
                    screenshotCtx.font = 'bold 24px Arial';
                    screenshotCtx.textAlign = 'center';
                    screenshotCtx.fillText('çœ¼åŠ¨è¿½è¸ªçƒ­åŠ›å›¾', screenshotCanvas.width / 2, screenshotCanvas.height / 2);
                }

                if (allTimeGazePoints.length > 0) {
                    debug(`æ­£åœ¨é‡å»ºçƒ­åŠ›å›¾ï¼ŒåŒ…å« ${allTimeGazePoints.length} ä¸ªç´¯ç§¯æ•°æ®ç‚¹`);

                    const tempHeatmapContainer = document.createElement('div');
                    tempHeatmapContainer.style.position = 'absolute';
                    tempHeatmapContainer.style.top = '0';
                    tempHeatmapContainer.style.left = '0';
                    tempHeatmapContainer.style.width = screenshotCanvas.width + 'px';
                    tempHeatmapContainer.style.height = screenshotCanvas.height + 'px';
                    tempHeatmapContainer.style.pointerEvents = 'none';
                    document.body.appendChild(tempHeatmapContainer);

                    const tempHeatmapInstance = h337.create({
                        container: tempHeatmapContainer,
                        radius: Math.max(25, screenshotCanvas.width / 60),
                        maxOpacity: 0.8,
                        minOpacity: 0.1,
                        blur: 0.8
                    });

                    const heatmapDataPoints = allTimeGazePoints.map(point => ({
                        x: point.x,
                        y: point.y,
                        value: 5
                    }));

                    tempHeatmapInstance.setData({
                        data: heatmapDataPoints,
                        max: 10
                    });

                    debug(`ä¸´æ—¶çƒ­åŠ›å›¾å·²åˆ›å»ºï¼ŒåŒ…å« ${heatmapDataPoints.length} ä¸ªæ•°æ®ç‚¹`);

                    await new Promise(resolve => setTimeout(resolve, 100));

                    const tempHeatmapCanvas = tempHeatmapContainer.querySelector('canvas');
                    if (tempHeatmapCanvas && tempHeatmapCanvas.width > 0 && tempHeatmapCanvas.height > 0) {
                        screenshotCtx.globalAlpha = 0.7;
                        screenshotCtx.drawImage(tempHeatmapCanvas, 0, 0, screenshotCanvas.width, screenshotCanvas.height);
                        screenshotCtx.globalAlpha = 1.0;
                        debug('çƒ­åŠ›å›¾å·²æˆåŠŸå åŠ åˆ°æˆªå›¾ä¸­');
                    } else {
                        debug('ä¸´æ—¶çƒ­åŠ›å›¾canvasæ— æ•ˆ');
                    }

                    document.body.removeChild(tempHeatmapContainer);
                } else {
                    debug('æ²¡æœ‰çƒ­åŠ›å›¾æ•°æ®å¯å åŠ ');
                }

                const infoX = 10;
                const infoY = 10;
                const infoHeight = 100;

                const infoLines = [
                    `å­¦å·: ${studentId} | å§“å: ${studentName}`, // æ·»åŠ å­¦ç”Ÿä¿¡æ¯
                    `ç”¨æˆ·ID: ${userId}`,
                    `è§†é¢‘æ—¶é—´: ${currentVideoTime.toFixed(4)}s`,
                    `æ³¨è§†ç‚¹æ•°: ${allTimeGazePoints.length}`,
                    `ä¼šè¯ID: ${sessionId.substring(0, 15)}...`
                ];

                screenshotCtx.font = 'bold 14px Arial';
                let maxTextWidth = 0;
                infoLines.forEach(line => {
                    const textWidth = screenshotCtx.measureText(line).width;
                    if (textWidth > maxTextWidth) {
                        maxTextWidth = textWidth;
                    }
                });
                const infoWidth = maxTextWidth + 20;

                screenshotCtx.fillStyle = 'rgba(33, 150, 243, 0.8)';
                screenshotCtx.fillRect(infoX, infoY, infoWidth, infoHeight);

                screenshotCtx.strokeStyle = '#2196F3';
                screenshotCtx.lineWidth = 3;
                screenshotCtx.setLineDash([]);
                screenshotCtx.strokeRect(infoX, infoY, infoWidth, infoHeight);

                screenshotCtx.fillStyle = '#FFFFFF';
                screenshotCtx.font = 'bold 14px Arial';
                screenshotCtx.textAlign = 'left';

                infoLines.forEach((line, index) => {
                    const textY = infoY + 20 + (index * 16);
                    screenshotCtx.fillText(line, infoX + 10, textY);
                });

                debug(`ç”¨æˆ·ä¿¡æ¯è¦†ç›–å±‚å·²ç»˜åˆ¶: ${infoWidth}x${infoHeight} ä½ç½®: (${infoX}, ${infoY})`);
                debug(`ğŸ“Š æˆªå›¾ä¿¡æ¯éªŒè¯ - æ˜¾ç¤ºè§†é¢‘æ—¶é—´: ${currentVideoTime.toFixed(4)}s, æœ‰æ—¶é—´æˆ³çš„çƒ­åŠ›å›¾ç‚¹: ${heatmapPointsWithVideoTime.length}`);

                const faceVideoX = 10;
                const faceVideoY = infoY + infoHeight + 10;

                if (webgazer && webgazer.isReady()) {
                    try {
                        const webgazerVideoElement = document.getElementById('webgazerVideoContainer');
                        const webgazerVideo = webgazerVideoElement ? webgazerVideoElement.querySelector('video') : null;

                        if (webgazerVideo && webgazerVideo.videoWidth > 0 && webgazerVideo.videoHeight > 0) {
                            debug('å¼€å§‹ç»˜åˆ¶äººè„¸è¾¹æ¡†åˆ°æˆªå›¾');

                            const faceVideoWidth = isFullscreen ? 240 : 320;
                            const faceVideoHeight = isFullscreen ? 180 : 240;

                            screenshotCtx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                            screenshotCtx.fillRect(faceVideoX - 5, faceVideoY - 5, faceVideoWidth + 10, faceVideoHeight + 10);

                            screenshotCtx.drawImage(webgazerVideo, faceVideoX, faceVideoY, faceVideoWidth, faceVideoHeight);

                            screenshotCtx.strokeStyle = '#00FF00';
                            screenshotCtx.lineWidth = 3;
                            screenshotCtx.setLineDash([]);
                            screenshotCtx.strokeRect(faceVideoX, faceVideoY, faceVideoWidth, faceVideoHeight);

                            if (webgazer.getTracker && webgazer.getTracker().getCurrentPosition) {
                                try {
                                    const facePosition = webgazer.getTracker().getCurrentPosition();
                                    if (facePosition && facePosition.length > 0) {
                                        screenshotCtx.fillStyle = '#FF0000';

                                        facePosition.forEach((point, index) => {
                                            if (point && typeof point.x === 'number' && typeof point.y === 'number') {
                                                const mappedX = faceVideoX + (point.x / webgazerVideo.videoWidth) * faceVideoWidth;
                                                const mappedY = faceVideoY + (point.y / webgazerVideo.videoHeight) * faceVideoHeight;

                                                screenshotCtx.beginPath();
                                                screenshotCtx.arc(mappedX, mappedY, 2, 0, 2 * Math.PI);
                                                screenshotCtx.fill();
                                            }
                                        });
                                        debug(`å·²ç»˜åˆ¶ ${facePosition.length} ä¸ªäººè„¸å…³é”®ç‚¹`);
                                    }
                                } catch (keyPointError) {
                                    debug(`è·å–äººè„¸å…³é”®ç‚¹å¤±è´¥: ${keyPointError.message}`);
                                }
                            }

                            screenshotCtx.font = 'bold 14px Arial';
                            screenshotCtx.fillStyle = '#FFFFFF';
                            screenshotCtx.textAlign = 'left';
                            screenshotCtx.fillText('äººè„¸æ£€æµ‹', faceVideoX, faceVideoY + faceVideoHeight + 20);

                            debug('äººè„¸è¾¹æ¡†å·²æˆåŠŸç»˜åˆ¶åˆ°æˆªå›¾ä¸­');
                        } else {
                            debug('æœªæ‰¾åˆ°æœ‰æ•ˆçš„WebGazerè§†é¢‘å…ƒç´ æˆ–è§†é¢‘æœªå‡†å¤‡å°±ç»ª');

                            const placeholderWidth = isFullscreen ? 240 : 320;
                            const placeholderHeight = isFullscreen ? 180 : 240;

                            screenshotCtx.strokeStyle = '#FF9800';
                            screenshotCtx.lineWidth = 3;
                            screenshotCtx.setLineDash([10, 5]);
                            screenshotCtx.strokeRect(faceVideoX, faceVideoY, placeholderWidth, placeholderHeight);

                            screenshotCtx.fillStyle = 'rgba(255, 152, 0, 0.2)';
                            screenshotCtx.fillRect(faceVideoX, faceVideoY, placeholderWidth, placeholderHeight);

                            screenshotCtx.font = 'bold 16px Arial';
                            screenshotCtx.fillStyle = '#FF9800';
                            screenshotCtx.textAlign = 'center';
                            screenshotCtx.fillText('äººè„¸æ£€æµ‹åŒºåŸŸ', faceVideoX + placeholderWidth/2, faceVideoY + placeholderHeight/2);
                            screenshotCtx.font = 'bold 12px Arial';
                            screenshotCtx.fillText('(æœªæ£€æµ‹åˆ°äººè„¸)', faceVideoX + placeholderWidth/2, faceVideoY + placeholderHeight/2 + 20);

                            debug('å·²ç»˜åˆ¶äººè„¸æ£€æµ‹å ä½ç¬¦');
                        }
                    } catch (faceError) {
                        debug(`ç»˜åˆ¶äººè„¸è¾¹æ¡†æ—¶å‡ºé”™: ${faceError.message}`);
                    }
                } else {
                    debug('WebGazeræœªå°±ç»ªï¼Œæ— æ³•ç»˜åˆ¶äººè„¸è¾¹æ¡†');

                    const placeholderWidth = isFullscreen ? 240 : 320;
                    const placeholderHeight = isFullscreen ? 180 : 240;

                    screenshotCtx.strokeStyle = '#FF0000';
                    screenshotCtx.lineWidth = 3;
                    screenshotCtx.setLineDash([5, 5]);
                    screenshotCtx.strokeRect(faceVideoX, faceVideoY, placeholderWidth, placeholderHeight);

                    screenshotCtx.fillStyle = 'rgba(255, 0, 0, 0.2)';
                    screenshotCtx.fillRect(faceVideoX, faceVideoY, placeholderWidth, placeholderHeight);

                    screenshotCtx.font = 'bold 16px Arial';
                    screenshotCtx.fillStyle = '#FF0000';
                    screenshotCtx.textAlign = 'center';
                    screenshotCtx.fillText('WebGazeræœªå°±ç»ª', faceVideoX + placeholderWidth/2, faceVideoY + placeholderHeight/2);

                    debug('å·²ç»˜åˆ¶WebGazeræœªå°±ç»ªå ä½ç¬¦');
                }

                const imageDataUrl = screenshotCanvas.toDataURL('image/png', 0.95);
                const cloudName = 'ddp3tohxk';
                const uploadPreset = 'index1';
                const url = `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`;

                const heatmapFileName = `${studentId}_${studentName}_${currentVideoTime.toFixed(2)}s_çƒ­åŠ›å›¾_${allTimeGazePoints.length}ç‚¹`;

                debug(`å‡†å¤‡ä¸Šä¼ å«äººè„¸è¾¹æ¡†çš„ç´¯ç§¯çƒ­åŠ›å›¾ï¼Œæ–‡ä»¶å: ${heatmapFileName}`);

                const formData = new FormData();
                formData.append('file', imageDataUrl);
                formData.append('upload_preset', uploadPreset);
                formData.append('folder', `å«äººè„¸è¾¹æ¡†çƒ­åŠ›å›¾/${studentId}_${studentName}/${sessionId}`);
                formData.append('public_id', heatmapFileName);

                const response = await fetch(url, { method: 'POST', body: formData });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Cloudinaryä¸Šä¼ å¤±è´¥: ${errorData.error.message}`);
                }
                const data = await response.json();
                const secureUrl = data.secure_url;
                debug(`å«äººè„¸è¾¹æ¡†çš„ç´¯ç§¯çƒ­åŠ›å›¾ä¸Šä¼ æˆåŠŸ: ${secureUrl}`);

                eyeTrackingData.heatmapSnapshots.push({
                    timestamp: new Date().toISOString(),
                    storageUrl: secureUrl,
                    provider: 'cloudinary',
                    sessionId,
                    userId,
                    studentId, // æ·»åŠ å­¦ç”Ÿä¿¡æ¯
                    studentName, // æ·»åŠ å­¦ç”Ÿä¿¡æ¯
                    videoTimestamp: currentVideoTime,
                    method: 'cumulative_heatmap_rebuild_with_face_detection_and_user_info',
                    fileName: heatmapFileName,
                    imageSize: `${screenshotCanvas.width}x${screenshotCanvas.height}`,
                    isFullscreen: isFullscreen,
                    captureType: 'cumulative_heatmap_with_face_border_and_user_info',
                    totalDataPoints: allTimeGazePoints.length,
                    dataPointsWithVideoTimestamp: heatmapPointsWithVideoTime.length,
                    videoTimestampRange: heatmapPointsWithVideoTime.length > 0 ? {
                        min: Math.min(...heatmapPointsWithVideoTime.map(p => p.videoTimestamp)),
                        max: Math.max(...heatmapPointsWithVideoTime.map(p => p.videoTimestamp))
                    } : null,
                    cumulativeData: true,
                    includeFaceBorder: true,
                    includeUserInfo: true,
                    timestampValidated: true
                });
                heatmapSnapshotCount++;
                updateStatsDisplay();

                debug(`âœ… çƒ­åŠ›å›¾æˆªå›¾å®Œæˆ - æ–‡ä»¶: ${heatmapFileName}, è§†é¢‘æ—¶é—´: ${currentVideoTime.toFixed(4)}s, éªŒè¯é€šè¿‡`);

            } catch (error) {
                console.error("æ•è·å«äººè„¸è¾¹æ¡†å’Œç”¨æˆ·ä¿¡æ¯çš„ç´¯ç§¯çƒ­åŠ›å›¾å¿«ç…§æ—¶å‡ºé”™: ", error);
                debug(`æ•è·å«äººè„¸è¾¹æ¡†å’Œç”¨æˆ·ä¿¡æ¯çš„ç´¯ç§¯çƒ­åŠ›å›¾å¿«ç…§æ—¶å‡ºé”™: ${error.message}`);
            } finally {
                heatmapContainer.style.visibility = originalVisibility;
                videoInfoOverlay.style.visibility = originalOverlayVisibility;
            }
        }

        function startAutoSave() {
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            autoSaveInterval = setInterval(() => saveEyeTrackingData(false), 5000);
            updateCollectionStatus('è¿›è¡Œä¸­ (è‡ªåŠ¨)', 'connected');
        }

        function stopAutoSave() { if (autoSaveInterval) clearInterval(autoSaveInterval); }

        async function saveEyeTrackingData(isManual = false) {
            if (!firebaseConnected) {
                if(isManual) swal('é”™è¯¯', 'Firebaseæœªè¿æ¥ï¼Œæ— æ³•ä¿å­˜ã€‚', 'error');
                return;
            }

            const totalPoints = eyeTrackingData.gazePoints.length + eyeTrackingData.saccades.length + eyeTrackingData.fixations.length;
            debug(`å‡†å¤‡ä¿å­˜æ•°æ® - æ³¨è§†ç‚¹: ${eyeTrackingData.gazePoints.length}, çœ¼è·³: ${eyeTrackingData.saccades.length}, æ³¨è§†: ${eyeTrackingData.fixations.length}, æ€»è®¡: ${totalPoints}, çƒ­åŠ›å›¾ç´¯ç§¯: ${allTimeGazePoints.length}`);

            if (totalPoints === 0) {
                debug('æ²¡æœ‰æ–°æ•°æ®å¯ä¿å­˜');
                if(isManual) swal('æç¤º', 'æ²¡æœ‰æ–°æ•°æ®å¯ä¿å­˜ã€‚', 'info');
                return;
            }

            const dataToSave = JSON.parse(JSON.stringify(eyeTrackingData));

            const videoTimestampGazePoints = dataToSave.gazePoints.filter(point => point.videoTimestamp !== null);
            const nonVideoTimestampGazePoints = dataToSave.gazePoints.filter(point => point.videoTimestamp === null);

            debug(`ğŸ“Š æ•°æ®éªŒè¯ - æœ‰è§†é¢‘æ—¶é—´æˆ³çš„æ³¨è§†ç‚¹: ${videoTimestampGazePoints.length}, æ— è§†é¢‘æ—¶é—´æˆ³çš„æ³¨è§†ç‚¹: ${nonVideoTimestampGazePoints.length}`);

            if (videoTimestampGazePoints.length > 0) {
                const minVideoTime = Math.min(...videoTimestampGazePoints.map(p => p.videoTimestamp));
                const maxVideoTime = Math.max(...videoTimestampGazePoints.map(p => p.videoTimestamp));
                debug(`ğŸ“Š è§†é¢‘æ—¶é—´æˆ³èŒƒå›´: ${minVideoTime.toFixed(4)}s - ${maxVideoTime.toFixed(4)}s`);
            }

            const payload = {
                sessionId,
                userId,
                studentId, // æ·»åŠ å­¦ç”Ÿä¿¡æ¯
                studentName, // æ·»åŠ å­¦ç”Ÿä¿¡æ¯
                timestamp: new Date().toISOString(),
                dataType: isManual ? 'manual' : 'auto',
                experimentType: 'video_eye_tracking',
                videoInfo: {
                    videoUrl: document.getElementById('eyeTrackingVideoPlayer').src,
                    videoDuration: document.getElementById('eyeTrackingVideoPlayer').duration || null,
                    currentVideoTime: document.getElementById('eyeTrackingVideoPlayer').currentTime || null
                },
                gazeData: dataToSave.gazePoints,
                saccadeData: dataToSave.saccades,
                fixationData: dataToSave.fixations,
                calibrationInfo: dataToSave.calibrationData,
                statistics: {
                    totalGazePoints: dataToSave.gazePoints.length,
                    totalSaccades: dataToSave.saccades.length,
                    totalFixations: dataToSave.fixations.length,
                    cumulativeHeatmapPoints: allTimeGazePoints.length,
                    videoTimestampGazePoints: videoTimestampGazePoints.length,
                    nonVideoTimestampGazePoints: nonVideoTimestampGazePoints.length,
                    videoTimestampRange: videoTimestampGazePoints.length > 0 ? {
                        min: Math.min(...videoTimestampGazePoints.map(p => p.videoTimestamp)),
                        max: Math.max(...videoTimestampGazePoints.map(p => p.videoTimestamp))
                    } : null,
                    averageFixationDuration: dataToSave.fixations.length > 0 ?
                        Math.round(dataToSave.fixations.reduce((sum, f) => sum + f.duration, 0) / dataToSave.fixations.length) : 0,
                    sessionDuration: Date.now() - startTime
                }
            };

            debug(`å‡†å¤‡ä¸Šä¼ Firebase payloadï¼Œç´¯ç§¯çƒ­åŠ›å›¾ç‚¹æ•°: ${allTimeGazePoints.length}`);
            debug(`ğŸ“Š Payloadç»Ÿè®¡ - æœ‰è§†é¢‘æ—¶é—´æˆ³: ${payload.statistics.videoTimestampGazePoints}, æ— è§†é¢‘æ—¶é—´æˆ³: ${payload.statistics.nonVideoTimestampGazePoints}`);

            eyeTrackingData.gazePoints = [];
            eyeTrackingData.saccades = [];
            eyeTrackingData.fixations = [];

            updateCollectionStatus('ä¿å­˜ä¸­...', 'uploading');
            try {
                const docRef = await db.collection("eye_tracking_video_experiment_v1").add(payload);
                snapshotCount++;
                updateCollectionStatus('è¿›è¡Œä¸­ (è‡ªåŠ¨)', 'connected');
                debug(`æ•°æ®å¿«ç…§ #${snapshotCount} ä¿å­˜æˆåŠŸï¼Œç´¯ç§¯çƒ­åŠ›å›¾ç‚¹æ•°: ${allTimeGazePoints.length}`);
                if(isManual) swal('æˆåŠŸ', `æ•°æ®å·²ä¿å­˜ï¼\nç´¯ç§¯çƒ­åŠ›å›¾ç‚¹æ•°: ${allTimeGazePoints.length}\næœ‰è§†é¢‘æ—¶é—´æˆ³: ${payload.statistics.videoTimestampGazePoints}\næ–‡æ¡£ID: ${docRef.id}`, 'success');
            } catch (error) {
                console.error("Firebase ä¿å­˜å¤±è´¥: ", error);
                debug(`æ•°æ®ä¿å­˜å¤±è´¥: ${error.message}, æ­£åœ¨æ¢å¤æ•°æ®...`);
                updateCollectionStatus('ä¿å­˜å¤±è´¥', 'disconnected');
                if(isManual) swal('å¤±è´¥', `æ•°æ®ä¿å­˜å¤±è´¥ï¼\n\n${error.message}`, 'error');
                eyeTrackingData.gazePoints = dataToSave.gazePoints.concat(eyeTrackingData.gazePoints);
                eyeTrackingData.saccades = dataToSave.saccades.concat(eyeTrackingData.saccades);
                eyeTrackingData.fixations = dataToSave.fixations.concat(eyeTrackingData.fixations);
            }
        }

        // =================================================================
        // MODIFICATION START: Functions for local data saving to Excel
        // =================================================================

        /**
         * è¿‡æ»¤ã€æ ¼å¼åŒ–åœ¨è§†é¢‘å®éªŒæœŸé—´æ”¶é›†çš„çœ¼åŠ¨æ•°æ®ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ°
         * ä¸€ä¸ªåŒ…å«å››ä¸ªå·¥ä½œè¡¨ï¼ˆSummaryã€Gaze Pointsã€Saccadesã€Fixationsï¼‰çš„Excelæ–‡ä»¶ä¸­ã€‚
         */
        function saveLocalData() {
            debug('å¼€å§‹å°†è§†é¢‘å®éªŒæ•°æ®ä¿å­˜åˆ°æœ¬åœ°Excelæ–‡ä»¶ã€‚');

            // 1. è¿‡æ»¤æ•°æ®ï¼šåªåŒ…æ‹¬ isVideoActive ä¸º true ä¸”æœ‰æœ‰æ•ˆè§†é¢‘æ—¶é—´æˆ³çš„è®°å½•ã€‚
            const videoGazePoints = sessionGazePoints.filter(p => p.isVideoActive && p.videoTimestamp !== null);
            const videoSaccades = sessionSaccades.filter(s => s.isVideoActive && s.startVideoTimestamp !== null);
            const videoFixations = sessionFixations.filter(f => f.isVideoActive && f.videoTimestamp !== null);

            debug(`å·²è¿‡æ»¤å¾…ä¿å­˜çš„æ•°æ®: ${videoGazePoints.length} ä¸ªæ³¨è§†ç‚¹, ${videoSaccades.length} ä¸ªçœ¼è·³, ${videoFixations.length} ä¸ªæ³¨è§†ã€‚`);

            if (videoGazePoints.length === 0 && videoSaccades.length === 0 && videoFixations.length === 0) {
                swal('æ— è§†é¢‘æ•°æ®', 'åœ¨è§†é¢‘æ’­æ”¾æœŸé—´æ²¡æœ‰æ”¶é›†åˆ°æœ‰æ•ˆçš„çœ¼åŠ¨æ•°æ®ï¼Œæ— æ³•ä¿å­˜ã€‚', 'info');
                return;
            }

            try {
                // åˆ›å»ºä¸€ä¸ªæ–°çš„å·¥ä½œç°¿
                const wb = XLSX.utils.book_new();
                const filePrefix = `eye_tracking_video_${studentId || 'unknown'}_${sessionId}`;
                const fileName = `${filePrefix}.xlsx`;

                // 2. åˆ›å»ºå¹¶æ·»åŠ  "Summary" å·¥ä½œè¡¨
                const totalFixationDuration = videoFixations.reduce((sum, f) => sum + f.duration, 0);
                const averageFixationDuration = videoFixations.length > 0 ? Math.round(totalFixationDuration / videoFixations.length) : 0;

                const summaryData = [
                    { 'é¡¹ç›® (Item)': 'å­¦å· (Student ID)', 'å€¼ (Value)': studentId || 'N/A' },
                    { 'é¡¹ç›® (Item)': 'å§“å (Student Name)', 'å€¼ (Value)': studentName || 'N/A' },
                    { 'é¡¹ç›® (Item)': 'ä¼šè¯ID (Session ID)', 'å€¼ (Value)': sessionId },
                    { 'é¡¹ç›® (Item)': 'ç”¨æˆ·ID (User ID)', 'å€¼ (Value)': userId },
                    { 'é¡¹ç›® (Item)': '---', 'å€¼ (Value)': '---' }, // åˆ†éš”ç¬¦
                    { 'é¡¹ç›® (Item)': 'ä¼šè¯æ€»æ—¶é•¿ (sessionDuration) (ms)', 'å€¼ (Value)': Date.now() - startTime },
                    { 'é¡¹ç›® (Item)': 'æ€»æ³¨è§†ç‚¹æ•° (totalGazePoints) [è§†é¢‘æœŸé—´]', 'å€¼ (Value)': videoGazePoints.length },
                    { 'é¡¹ç›® (Item)': 'æ€»æ³¨è§†æ¬¡æ•° (totalFixations) [è§†é¢‘æœŸé—´]', 'å€¼ (Value)': videoFixations.length },
                    { 'é¡¹ç›® (Item)': 'æ€»çœ¼è·³æ¬¡æ•° (totalSaccades) [è§†é¢‘æœŸé—´]', 'å€¼ (Value)': videoSaccades.length },
                    { 'é¡¹ç›® (Item)': 'å¹³å‡æ³¨è§†æ—¶é•¿ (averageFixationDuration) (ms)', 'å€¼ (Value)': averageFixationDuration },
                    { 'é¡¹ç›® (Item)': 'ç´¯ç§¯çƒ­åŠ›å›¾ç‚¹æ•° (cumulativeHeatmapPoints) [å…¨è¿‡ç¨‹]', 'å€¼ (Value)': allTimeGazePoints.length }
                ];
                
                const wsSummary = XLSX.utils.json_to_sheet(summaryData);
                // è°ƒæ•´åˆ—å®½ä»¥è·å¾—æ›´å¥½çš„å¯è¯»æ€§
                wsSummary['!cols'] = [{ wch: 45 }, { wch: 40 }]; 
                XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');
                debug('â€œSummaryâ€å·¥ä½œè¡¨å·²åˆ›å»ºã€‚');


                // 3. å¤„ç†å¹¶æ·»åŠ â€œGaze Pointsâ€å·¥ä½œè¡¨
                if (videoGazePoints.length > 0) {
                    const gazeData = videoGazePoints.map(p => ({
                        'è§†é¢‘æ—¶é—´æˆ³ (s)': p.videoTimestamp,
                        'å±å¹•åæ ‡ X': p.x,
                        'å±å¹•åæ ‡ Y': p.y,
                        'è§†é¢‘å†…ç›¸å¯¹åæ ‡ X': p.relativeX,
                        'è§†é¢‘å†…ç›¸å¯¹åæ ‡ Y': p.relativeY,
                        'ç³»ç»Ÿæ—¶é—´æˆ³': p.timestamp,
                        'æ˜¯å¦å…¨å±': p.isFullscreen
                    }));
                    const wsGaze = XLSX.utils.json_to_sheet(gazeData);
                    XLSX.utils.book_append_sheet(wb, wsGaze, 'Gaze Points');
                    debug('â€œGaze Pointsâ€å·¥ä½œè¡¨å·²åˆ›å»ºã€‚');
                }

                // 4. å¤„ç†å¹¶æ·»åŠ â€œSaccadesâ€å·¥ä½œè¡¨
                if (videoSaccades.length > 0) {
                    const flatSaccades = videoSaccades.map(s => ({
                        'å¼€å§‹è§†é¢‘æ—¶é—´æˆ³ (s)': s.startVideoTimestamp,
                        'ç»“æŸè§†é¢‘æ—¶é—´æˆ³ (s)': s.endVideoTimestamp,
                        'èµ·å§‹ç‚¹ X': s.startPoint.x,
                        'èµ·å§‹ç‚¹ Y': s.startPoint.y,
                        'ç»“æŸç‚¹ X': s.endPoint.x,
                        'ç»“æŸç‚¹ Y': s.endPoint.y,
                        'è·ç¦» (px)': s.distance,
                        'æŒç»­æ—¶é—´ (ms)': s.duration
                    }));
                    const wsSaccades = XLSX.utils.json_to_sheet(flatSaccades);
                    XLSX.utils.book_append_sheet(wb, wsSaccades, 'Saccades');
                    debug('â€œSaccadesâ€å·¥ä½œè¡¨å·²åˆ›å»ºã€‚');
                }

                // 5. å¤„ç†å¹¶æ·»åŠ â€œFixationsâ€å·¥ä½œè¡¨
                if (videoFixations.length > 0) {
                    const flatFixations = videoFixations.map(f => ({
                        'å¼€å§‹è§†é¢‘æ—¶é—´æˆ³ (s)': f.videoTimestamp,
                        'ç»“æŸè§†é¢‘æ—¶é—´æˆ³ (s)': f.endVideoTimestamp,
                        'æŒç»­æ—¶é—´ (ms)': f.duration,
                        'ä¸­å¿ƒç‚¹ X': f.centerPoint.x,
                        'ä¸­å¿ƒç‚¹ Y': f.centerPoint.y,
                        'åŒ…å«æ³¨è§†ç‚¹æ•°': f.pointCount
                    }));
                    const wsFixations = XLSX.utils.json_to_sheet(flatFixations);
                    XLSX.utils.book_append_sheet(wb, wsFixations, 'Fixations');
                    debug('â€œFixationsâ€å·¥ä½œè¡¨å·²åˆ›å»ºã€‚');
                }

                // 6. è§¦å‘Excelæ–‡ä»¶ä¸‹è½½
                XLSX.writeFile(wb, fileName);
                debug(`Excel æ–‡ä»¶ '${fileName}' ä¸‹è½½å·²è§¦å‘ã€‚`);
                
                swal('æœ¬åœ°ä¿å­˜å®Œæˆ', `çœ¼åŠ¨æ•°æ®å·²ç”ŸæˆExcelæ–‡ä»¶ (${fileName}) å¹¶å¼€å§‹ä¸‹è½½ã€‚è¯·æ£€æŸ¥æ‚¨çš„ä¸‹è½½æ–‡ä»¶å¤¹ã€‚`, 'success');

            } catch (error) {
                console.error('ç”Ÿæˆæˆ–ä¿å­˜Excelæ–‡ä»¶å¤±è´¥:', error);
                debug(`ç”ŸæˆExcelæ–‡ä»¶æ—¶å‡ºé”™: ${error.message}`);
                swal('ä¿å­˜å¤±è´¥', 'ç”ŸæˆExcelæ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ã€‚', 'error');
            }
        }
        // =================================================================
        // MODIFICATION END
        // =================================================================


        // =======================================================================
        // å®˜æ–¹æ ¡å‡†ä¸ç™¾åˆ†æ¯”ç²¾åº¦æµ‹è¯•æµç¨‹
        // =======================================================================

        function ClearCanvas(){
            document.querySelectorAll('.Calibration').forEach((i) => { i.style.display = 'none'; });
            var canvas = document.getElementById("plotting_canvas");
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
        }

        function PopUpInstruction() {
            if (!isTracking) return swal('æç¤º', 'è¯·å…ˆå¯åŠ¨çœ¼åŠ¨è¿½è¸ªã€‚', 'info');

            isCalibrating = true;

            document.getElementById('statsPanel').style.display = 'none';
            document.querySelector('.controls').style.display = 'none';
            ClearCanvas();
            swal({
                title:"æ ¡å‡†è¯´æ˜",
                text: "è¯·ç‚¹å‡»å±å¹•ä¸Šå‡ºç°çš„9ä¸ªç‚¹ã€‚æ‚¨å¿…é¡»åœ¨æ¯ä¸ªç‚¹ä¸Šç‚¹å‡»5æ¬¡ï¼Œç›´åˆ°å®ƒå˜æˆé»„è‰²ã€‚è¿™å°†æ ¡å‡†æ‚¨çš„çœ¼åŠ¨è¿½è¸ªã€‚",
                buttons:{ cancel: false, confirm: "å¼€å§‹" }
            }).then(() => {
                updateStatus('æ ¡å‡†è¿›è¡Œä¸­', 'calibrating');
                debug('å¼€å§‹9ç‚¹æ ¡å‡†æµç¨‹');
                ShowCalibrationPoint();
                document.querySelectorAll('.Calibration').forEach((i) => { i.onclick = () => calPointClick(i); });
            });
        }

        function ShowCalibrationPoint() {
            document.querySelectorAll('.Calibration').forEach((i) => { i.style.display = 'block'; });
            document.getElementById('Pt5').style.display = 'none';
        }

        function calPointClick(node) {
            const id = node.id;
            if (!CalibrationPoints[id]) CalibrationPoints[id] = 0;
            CalibrationPoints[id]++;
            node.style.opacity = 0.2 * CalibrationPoints[id] + 0.2;
            if (CalibrationPoints[id] == 5) {
                node.style.backgroundColor = 'yellow';
                node.setAttribute('disabled', 'disabled');
                PointCalibrate++;
                debug(`æ ¡å‡†ç‚¹ ${id} å®Œæˆï¼Œå½“å‰å®Œæˆæ•°é‡: ${PointCalibrate}`);

                if (PointCalibrate === 8) {
                    document.getElementById('Pt5').style.display = 'block';
                    debug('æ˜¾ç¤ºç¬¬9ä¸ªæ ¡å‡†ç‚¹ Pt5');
                }
                if (PointCalibrate === 9) {
                    debug('æ‰€æœ‰æ ¡å‡†ç‚¹å®Œæˆï¼Œå¼€å§‹ç²¾åº¦è®¡ç®—');
                    document.querySelectorAll('.Calibration').forEach((i) => { if(i.id !== 'Pt5') i.style.display = 'none'; });
                    calcAccuracy();
                }
            }
        }

        function calcAccuracy() {
            swal({
                title: "æ­£åœ¨è®¡ç®—ç²¾åº¦",
                text: "è¯·ä¸è¦ç§»åŠ¨æ‚¨çš„é¼ æ ‡ï¼Œå¹¶å°½åŠ›æ³¨è§†å±å¹•ä¸­å¤®çš„ç‚¹5ç§’é’Ÿã€‚è¿™å°†å¸®åŠ©æˆ‘ä»¬è®¡ç®—é¢„æµ‹çš„å‡†ç¡®æ€§ã€‚",
                closeOnEsc: false, allowOutsideClick: false, closeModal: true
            }).then(() => {
                updateStatus('ç²¾åº¦æµ‹è¯•ä¸­...', 'calibrating');
                if (webgazer) webgazer.params.storingPoints = true;
                sleep(5000).then(() => {
                    if (webgazer) webgazer.params.storingPoints = false;
                    var past50 = webgazer.getStoredPoints();
                    var precisionPercentage = calculatePrecision(past50);

                    document.getElementById('Accuracy').innerHTML = `æµ‹è¯•ç²¾åº¦: ${precisionPercentage}%`;
                    eyeTrackingData.calibrationData = {
                        points: CalibrationPoints,
                        accuracyPercentage: precisionPercentage,
                        timestamp: new Date().toISOString()
                    };

                    swal({
                        title: `æ‚¨çš„è¿½è¸ªç²¾åº¦ä¸º ${precisionPercentage}%`,
                        allowOutsideClick: false,
                        buttons: { cancel: "é‡æ–°æ ¡å‡†", confirm: "æ¥å—" }
                    }).then(isConfirm => {
                        document.getElementById('statsPanel').style.display = 'block';
                        document.querySelector('.controls').style.display = 'block';
                        if (isConfirm) {
                            ClearCanvas();
                            updateStatus('è¿è¡Œä¸­', 'ready');
                            isCalibrating = false;
                        } else {
                            document.getElementById("Accuracy").innerHTML = "ç­‰å¾…æ ¡å‡†...";
                            webgazer.clearData();
                            Restart();
                        }
                    });
                });
            });
        }

        function sleep(time) { return new Promise((resolve) => setTimeout(resolve, time)); }

        function calculatePrecision(past50Array) {
          var windowHeight = window.innerHeight;
          var staringPointX = window.innerWidth / 2;
          var staringPointY = windowHeight / 2;
          var x50 = past50Array[0];
          var y50 = past50Array[1];
          var precisionPercentages = new Array(50);
          for (let x = 0; x < 50; x++) {
            var xDiff = staringPointX - x50[x];
            var yDiff = staringPointY - y50[x];
            var distance = Math.sqrt((xDiff * xDiff) + (yDiff * yDiff));
            var halfWindowHeight = windowHeight / 2;
            var precision = 100 - (distance / halfWindowHeight * 100);
            precisionPercentages[x] = Math.max(0, precision);
          }
          return Math.round(precisionPercentages.reduce((a, b) => a + b, 0) / 50);
        };

        function Restart() {
            if (!webgazerReady) return;
            document.getElementById('Accuracy').innerHTML = "ç­‰å¾…æ ¡å‡†...";
            if(webgazer) webgazer.clearData();
            ClearCalibration();
            ClearCanvas();
            updateStatus('å‡†å¤‡é‡æ–°æ ¡å‡†', 'ready');
            document.querySelector('.controls').style.display = 'none';
            PopUpInstruction();
        }

        function ClearCalibration() {
            document.querySelectorAll('.Calibration').forEach((i) => {
                i.style.backgroundColor = 'red';
                i.style.opacity = '0.2';
                i.removeAttribute('disabled');
            });
            CalibrationPoints = {};
            PointCalibrate = 0;
        }

        // =======================================================================
        // ç³»ç»Ÿæ§åˆ¶ä¸ç”Ÿå‘½å‘¨æœŸ
        // =======================================================================

        function toggleDebug() { debugMode = !debugMode; document.getElementById('debugPanel').style.display = debugMode ? 'block' : 'none'; }

        function toggleHeatmap() {
            const heatmapContainer = document.getElementById('heatmapContainer');
            heatmapContainer.classList.toggle('heatmap-visible');
            heatmapContainer.style.visibility = heatmapContainer.classList.contains('heatmap-visible') ? 'visible' : 'hidden';
        }

        function startStatsUpdate() {
            if (statsUpdateInterval) clearInterval(statsUpdateInterval);
            statsUpdateInterval = setInterval(() => { if (isTracking) { document.getElementById('runningTime').textContent = Math.round((Date.now() - startTime) / 1000) + 's'; updateStatsDisplay(); } }, 1000);
        }
        function stopStatsUpdate() { if (statsUpdateInterval) clearInterval(statsUpdateInterval); }

        function exportData() {
            if (gazeCount === 0) return swal('æ— æ•°æ®', 'æ²’æœ‰å¯å¯¼å‡ºçš„æ•°æ®ã€‚', 'warning');
            const dataStr = JSON.stringify({ sessionInfo: { sessionId, userId, studentId, studentName }, collectedData: eyeTrackingData }, null, 2);
            const link = document.createElement('a');
            link.href = URL.createObjectURL(new Blob([dataStr], {type: 'application/json'}));
            link.download = `eye-tracking-data-${studentId}-${sessionId}.json`;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        async function initializeSystem() {
            try {
                if (typeof h337 === 'undefined' || typeof swal === 'undefined' || typeof XLSX === 'undefined') throw new Error('ä¾èµ–åº“åŠ è½½å¤±è´¥');
                if (!await loadWebGazerScript() || typeof webgazer === 'undefined') throw new Error('WebGazeråŠ è½½å¤±è´¥');
                heatmapInstance = h337.create({ container: document.getElementById('heatmapContainer'), radius: 25, maxOpacity: 0.6, minOpacity: 0.1, blur: 0.8 });
                await testFirebaseConnection();
                updateStatus('ç³»ç»Ÿå°±ç»ª', 'ready');
                document.getElementById('startBtn').disabled = false;
                librariesLoaded = true;
                ClearCanvas();
                setupVideoPlayer();
            } catch (error) {
                updateStatus('åˆå§‹åŒ–å¤±è´¥', 'error');
                swal('ä¸¥é‡é”™è¯¯', `ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:\n\n${error.message}`, 'error');
            }
        }

        async function startEyeTracking() {
            if (!librariesLoaded) return;
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            updateStatus('åˆå§‹åŒ–WebGazer...', 'initializing');
            try {
                await webgazer.setRegression('ridge').setTracker('clmtrackr').setGazeListener(gazeDataCallback).begin();
                webgazer.showVideoPreview(true).showPredictionPoints(true).applyKalmanFilter(true);
                isTracking = true; startTime = Date.now(); webgazerReady = true;
                if (firebaseConnected) startAutoSave();
                startHeatmapSnapshots(); startStatsUpdate();
                updateStatus('è¿è¡Œä¸­', 'ready');
                document.getElementById('calibrateBtn').disabled = false;
                startBtn.textContent = 'âœ… è¿è¡Œä¸­';
                swal('å¯åŠ¨æˆåŠŸ', 'çœ¼åŠ¨è¿½è¸ªå·²å¯åŠ¨ï¼\nå¼ºçƒˆå»ºè®®æ‚¨ç‚¹å‡»â€œå¼€å§‹æ ¡å‡†â€ä»¥æé«˜ç²¾åº¦ã€‚', 'success');
            } catch (error) {
                console.error("å¯åŠ¨çœ¼åŠ¨è¿½è¸ªå¤±è´¥:", error);
                updateStatus('å¯åŠ¨å¤±è´¥', 'error');
                startBtn.disabled = false;
                swal('å¯åŠ¨å¤±è´¥', `æ— æ³•å¯åŠ¨çœ¼åŠ¨è¿½è¸ªã€‚\nè¯·æ£€æŸ¥æ‘„åƒå¤´æƒé™ã€‚\n\n${error.message}`, 'error');
            }
        }

        async function performStop() {
            if (firebaseConnected) await saveEyeTrackingData(true);
            isTracking = false;
            stopAutoSave(); stopHeatmapSnapshots(); stopStatsUpdate();
            if (typeof webgazer !== 'undefined' && webgazer.isReady()) {
                webgazer.end();
                debug("WebGazer.end() å·²è°ƒç”¨ï¼Œåœæ­¢è¿½è¸ªã€‚");
            }
            ClearCalibration();
            ClearCanvas();

            debug(`åœæ­¢æ—¶ä¿ç•™ ${allTimeGazePoints.length} ä¸ªç´¯ç§¯çƒ­åŠ›å›¾æ•°æ®ç‚¹`);

            updateStatus('å·²åœæ­¢', 'error');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').textContent = 'ğŸš€ å¯åŠ¨çœ¼åŠ¨è¿½è¸ª';
            document.getElementById('calibrateBtn').disabled = true;
        }

        // ä¿®æ”¹ï¼šå°†å¯åŠ¨æµç¨‹æŒ‡å‘ä¿¡æ¯æ”¶é›†
        window.addEventListener('load', collectStudentInfo);

        window.addEventListener('error', (e) => debug(`å…¨å±€é”™è¯¯: ${e.message}`));
        window.addEventListener('unhandledrejection', (e) => debug(`Promiseæ‹’ç»: ${e.reason}`));
        window.addEventListener('beforeunload', (e) => {
            if (isTracking && eyeTrackingData.gazePoints.length > 0) {
                const message = 'æ‚¨æœ‰æœªä¿å­˜çš„æ•°æ®ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
                e.returnValue = message; return message;
            }
        });
        document.addEventListener('visibilitychange', () => {
            if (isTracking && webgazer) {
                document.visibilityState === 'hidden' ? webgazer.pause() : webgazer.resume();
            }
        });
    </script>
</body>
</html>
